rdkit_disable_log: true

dataset:
  train:
    - class: DynamicBatchWrapper
      dataset:
        class: RAGBatchWrapper
        dataset:
          class: DynamicBlockWrapper
          dataset:
            class: MixDatasetWrapper
            datasets:
              - class: PeptideDataset
                mmap_dir: ./datasets/peptide/pepbench/processed
                specify_index: ./datasets/peptide/pepbench/processed/train_index.txt
                cluster: ./datasets/peptide/pepbench/train.cluster
              - class: PeptideDataset
                mmap_dir: ./datasets/peptide/pepbench/processed
                specify_index: ./datasets/peptide/pepbench/processed/non_standard_index.txt
              - class: PeptideDataset
                mmap_dir: ./datasets/peptide/ProtFrag/processed
          seed: 2025
          partition_seeds: [202501, 202502, 202503, 202504, 202505, 202506, 114514, 202507, 202509, 202511, 202513]
          max_attempts: 5
          storage_path: ./datasets/peptide/subgraphs.dynamic.train.jsonl
          storage_min_heavy_atoms: 4
          storage_metadata: true
          allow_single_fragment_fallback: true
          peptide_smiles_map: ./datasets/peptide/peptide_smiles_all.jsonl
          peptide_smiles_prob: 0.9
          peptide_num_part_ratios: [1.5, 1.25, 1.0, 0.8]
          min_heavy_atoms: [8, 6, 4]
          invalid_log_path: ./logs/invalid_dynamic_fragments.peptide.train.jsonl
      complexity: n*n
      ubound_per_batch: 12000000
      n_use_max_in_batch: true
    - class: DynamicBatchWrapper
      dataset:
        class: RAGBatchWrapper
        dataset:
          class: DynamicBlockWrapper
          dataset:
            class: MoleculeDataset
            mmap_dir: ./datasets/molecule/CrossDocked/processed
            specify_index: ./datasets/molecule/CrossDocked/processed/train_index.txt
            length_type: atom
          num_parts: [5, 4, 3, 2]
          seed: 1234
          max_attempts: 5
          storage_path: ./datasets/molecule/CrossDocked/subgraphs.dynamic.jsonl
          min_heavy_atoms: [8, 6, 4]
          fallback_max_heavy_atoms: 40
          allow_single_fragment_fallback: true
          invalid_log_path: ./logs/invalid_dynamic_fragments.train.jsonl
          storage_min_heavy_atoms: 8
          storage_metadata: true
      complexity: n*n
      ubound_per_batch: 12000000
      n_use_max_in_batch: true
  valid:
    - class: DynamicBatchWrapper
      dataset:
        class: RAGBatchWrapper
        dataset:
          class: DynamicBlockWrapper
          dataset:
            class: PeptideDataset
            mmap_dir: ./datasets/peptide/pepbench/processed
            specify_index: ./datasets/peptide/pepbench/processed/valid_index.txt
          seed: 5678
          max_attempts: 5
          storage_path: ./datasets/peptide/subgraphs.dynamic.valid.jsonl
          storage_min_heavy_atoms: 4
          storage_metadata: true
          allow_single_fragment_fallback: true
          peptide_smiles_map: ./datasets/peptide/peptide_smiles_all.jsonl
          peptide_smiles_prob: 0.8
          peptide_num_part_ratios: [1.5, 1.3, 1.0]
          min_heavy_atoms: [6, 4]
          invalid_log_path: ./logs/invalid_dynamic_fragments.peptide.valid.jsonl
      complexity: n*n
      ubound_per_batch: 12000000
      n_use_max_in_batch: true
    - class: DynamicBatchWrapper
      dataset:
        class: RAGBatchWrapper
        dataset:
          class: DynamicBlockWrapper
          dataset:
            class: MoleculeDataset
            mmap_dir: ./datasets/molecule/CrossDocked/processed
            specify_index: ./datasets/molecule/CrossDocked/processed/valid_index.txt
            length_type: atom
          num_parts: [2, 3, 4]
          seed: 5678
          max_attempts: 5
          storage_path: ./datasets/molecule/CrossDocked/subgraphs.dynamic.jsonl
          min_heavy_atoms: [8, 6, 4]
          min_fragment_atoms: 4
          invalid_log_path: ./logs/invalid_dynamic_fragments.valid.jsonl
          storage_min_heavy_atoms: 8
          storage_metadata: true
      complexity: n*n
      ubound_per_batch: 12000000
      n_use_max_in_batch: true

dataloader:
  train:
    num_workers: 16
  valid:
    num_workers: 8

trainer:
  class: IterAETrainer
  criterion: loss
  config:
    max_epoch: 300
    save_topk: 5
    val_freq: 2
    save_dir: ./ckpts/unimomo_rag_dynamic
    grad_clip: 1.0
    patience: 10
    warmup: 2000
    metric_min_better: true
    logger: tensorboard
    optimizer:
      class: AdamW
      lr: 1.0e-4
    scheduler:
      class: ReduceLROnPlateau
      factor: 0.8
      patience: 5
      mode: min
      frequency: val_epoch
      min_lr: 5.0e-6

model:
  class: CondIterAutoEncoder
  encoder_type: EPT
  decoder_type: EPT
  embed_size: 512
  hidden_size: 512
  latent_size: 8
  edge_size: 64
  k_neighbors: 9
  encoder_opt:
    n_rbf: 64
    cutoff: 10.0
    n_layers: 6
    n_head: 8
    use_edge_feat: true
    pre_norm: true
    efficient: false
    vector_act: layernorm
  decoder_opt:
    n_rbf: 64
    cutoff: 10.0
    n_layers: 6
    n_head: 8
    use_edge_feat: true
    pre_norm: true
    efficient: false
    vector_act: layernorm
  loss_weights:
    Zh_kl_loss: 0.6
    Zx_kl_loss: 0.8
    atom_coord_loss: 1.0
    block_type_loss: 0.0
    contrastive_loss: 0.0
    local_distance_loss: 0.5
    bond_loss: 0.5
    bond_length_loss: 0.0
    rag_contrastive_loss: 0.1
    retrieval_loss: 0.0
  prior_coord_std: 1.0
  coord_noise_scale: 1.0
  pocket_mask_ratio: 0.05
  decode_mask_ratio: 0.0
  kl_on_pocket: false
  discrete_timestep: false
  rag_opt:
    subgraph_index: ./datasets/molecule/CrossDocked/subgraphs.dynamic.sample5k.jsonl
    hidden_size: 512
    num_layers: 3
    temperature: 0.01
    negatives_per_pos: 150
    readout: mean
    debug: true
    strict_dynamic_pos: true
    use_full_inbatch_negatives: true
    share_inbatch_negatives: true
    cross_modal_neg_ratio: 0.5
    zero_positive_log: ./logs/rag_zero_positive.jsonl
    zero_detail_log: ./logs/rag_zero_positive_detail.jsonl
    success_detail_log: ./logs/rag_positive_detail.jsonl
    batch_diagnostics_log: ./logs/rag_batch_diagnostics.jsonl
    fragment_frequency_log: ./logs/rag_positive_fragment_frequency.jsonl
    fragment_freq_log_every: 100
    success_log_every: 1000
    zero_log_every: 1

load_ckpt: ''
